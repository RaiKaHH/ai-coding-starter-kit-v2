{% extends "base.html" %}
{% block title %}{{ page_title }}{% endblock %}
{% block content %}

<div x-data="historyApp()" x-init="init()">

  <h1 class="text-2xl font-bold mb-6">{{ page_title }}</h1>

  <!-- ================================================================== -->
  <!-- BATCH OVERVIEW                                                      -->
  <!-- ================================================================== -->
  <section class="mb-8">
    <h2 class="text-lg font-semibold mb-3 text-gray-700">Batch-Aktionen</h2>

    <template x-if="batchesLoading">
      <div class="text-sm text-gray-500 scan-pulse">Batches werden geladen...</div>
    </template>

    <template x-if="!batchesLoading && batches.length === 0">
      <div class="text-sm text-gray-400">Noch keine Batch-Operationen vorhanden.</div>
    </template>

    <div class="grid gap-3 md:grid-cols-2 lg:grid-cols-3">
      <template x-for="batch in batches" :key="batch.batch_id">
        <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
          <div class="flex items-start justify-between gap-2 mb-2">
            <div>
              <span class="text-xs font-mono text-gray-400" x-text="batch.batch_id.substring(0, 8) + '...'"></span>
              <p class="text-sm font-medium text-gray-800">
                <span x-text="batch.file_count"></span> Dateien
                <span x-text="batch.operation_type === 'MOVE' ? 'verschoben' : 'umbenannt'"></span>
              </p>
              <p class="text-xs text-gray-500" x-text="formatTimestamp(batch.timestamp)"></p>
            </div>
            <span
              class="text-xs font-medium px-2 py-0.5 rounded-full whitespace-nowrap"
              :class="{
                'bg-green-100 text-green-700': batch.status === 'completed',
                'bg-blue-100 text-blue-700': batch.status === 'reverted',
                'bg-yellow-100 text-yellow-700': batch.status === 'partially_reverted'
              }"
              x-text="batch.status === 'completed' ? 'Erledigt' : batch.status === 'reverted' ? 'Rueckgaengig' : 'Teilweise'"
            ></span>
          </div>

          <!-- Progress bar (during batch undo) -->
          <template x-if="undoProgress[batch.batch_id] && !undoProgress[batch.batch_id].done">
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                <div
                  class="bg-brand-500 h-2 rounded-full transition-all duration-300"
                  :style="'width: ' + Math.round(((undoProgress[batch.batch_id].reverted + undoProgress[batch.batch_id].failed) / undoProgress[batch.batch_id].total) * 100) + '%'"
                ></div>
              </div>
              <p class="text-xs text-gray-500">
                <span x-text="undoProgress[batch.batch_id].reverted + undoProgress[batch.batch_id].failed"></span>
                / <span x-text="undoProgress[batch.batch_id].total"></span> bearbeitet...
              </p>
            </div>
          </template>

          <!-- Completion summary -->
          <template x-if="undoProgress[batch.batch_id] && undoProgress[batch.batch_id].done">
            <div class="mt-2 text-xs">
              <span class="text-green-600" x-text="undoProgress[batch.batch_id].reverted + ' rueckgaengig'"></span>
              <template x-if="undoProgress[batch.batch_id].failed > 0">
                <span class="text-red-600 ml-1" x-text="', ' + undoProgress[batch.batch_id].failed + ' fehlgeschlagen'"></span>
              </template>
            </div>
          </template>

          <!-- Undo button -->
          <template x-if="batch.status === 'completed'">
            <button
              class="mt-3 w-full text-sm font-medium px-3 py-1.5 rounded-md border border-red-300 text-red-600 hover:bg-red-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              :disabled="undoProgress[batch.batch_id] && !undoProgress[batch.batch_id].done"
              @click="confirmBatchUndo(batch)"
            >
              Ganzen Batch rueckgaengig machen
            </button>
          </template>
        </div>
      </template>
    </div>
  </section>

  <!-- ================================================================== -->
  <!-- FILTER BAR                                                          -->
  <!-- ================================================================== -->
  <section class="mb-4 flex flex-wrap items-center gap-3">
    <h2 class="text-lg font-semibold text-gray-700">Einzel-Operationen</h2>
    <div class="flex gap-1 ml-auto">
      <button
        class="text-xs px-3 py-1 rounded-md font-medium transition-colors"
        :class="filter === null ? 'bg-brand-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
        @click="filter = null; page = 1; loadOperations()"
      >Alle</button>
      <button
        class="text-xs px-3 py-1 rounded-md font-medium transition-colors"
        :class="filter === 'MOVE' ? 'bg-brand-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
        @click="filter = 'MOVE'; page = 1; loadOperations()"
      >Nur MOVE</button>
      <button
        class="text-xs px-3 py-1 rounded-md font-medium transition-colors"
        :class="filter === 'RENAME' ? 'bg-brand-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
        @click="filter = 'RENAME'; page = 1; loadOperations()"
      >Nur RENAME</button>
    </div>
  </section>

  <!-- ================================================================== -->
  <!-- OPERATIONS TABLE                                                    -->
  <!-- ================================================================== -->
  <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
    <template x-if="opsLoading">
      <div class="p-6 text-sm text-gray-500 scan-pulse">Operationen werden geladen...</div>
    </template>

    <template x-if="!opsLoading && operations.length === 0">
      <div class="p-6 text-sm text-gray-400">Keine Operationen vorhanden.</div>
    </template>

    <template x-if="!opsLoading && operations.length > 0">
      <div class="overflow-x-auto custom-scrollbar">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-4 py-2 text-left font-medium text-gray-500">Zeitstempel</th>
              <th class="px-4 py-2 text-left font-medium text-gray-500">Typ</th>
              <th class="px-4 py-2 text-left font-medium text-gray-500">Dateiname</th>
              <th class="px-4 py-2 text-left font-medium text-gray-500">Von</th>
              <th class="px-4 py-2 text-left font-medium text-gray-500">Nach</th>
              <th class="px-4 py-2 text-left font-medium text-gray-500">Status</th>
              <th class="px-4 py-2 text-left font-medium text-gray-500">Aktion</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <template x-for="op in operations" :key="op.id">
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-2 text-xs text-gray-500 whitespace-nowrap" x-text="formatTimestamp(op.timestamp)"></td>
                <td class="px-4 py-2">
                  <span
                    class="text-xs font-medium px-1.5 py-0.5 rounded"
                    :class="op.operation_type === 'MOVE' ? 'bg-purple-100 text-purple-700' : 'bg-indigo-100 text-indigo-700'"
                    x-text="op.operation_type"
                  ></span>
                </td>
                <td class="px-4 py-2 font-medium text-gray-800 max-w-[200px] truncate" :title="extractFileName(op.target_path)" x-text="extractFileName(op.target_path)"></td>
                <td class="px-4 py-2 text-xs text-gray-500 max-w-[200px] truncate" :title="op.source_path" x-text="shortenPath(op.source_path)"></td>
                <td class="px-4 py-2 text-xs text-gray-500 max-w-[200px] truncate" :title="op.target_path" x-text="shortenPath(op.target_path)"></td>
                <td class="px-4 py-2">
                  <span
                    class="text-xs font-medium px-2 py-0.5 rounded-full"
                    :class="{
                      'bg-green-100 text-green-700': op.status === 'completed',
                      'bg-blue-100 text-blue-700': op.status === 'reverted',
                      'bg-red-100 text-red-700': op.status === 'revert_failed'
                    }"
                    x-text="op.status === 'completed' ? 'Erledigt' : op.status === 'reverted' ? 'Rueckgaengig' : 'Fehlgeschlagen'"
                    :title="op.status === 'revert_failed' ? 'Datei wurde manuell geloescht oder verschoben' : ''"
                  ></span>
                </td>
                <td class="px-4 py-2">
                  <template x-if="op.status === 'completed'">
                    <button
                      class="text-xs font-medium px-2 py-1 rounded border border-amber-300 text-amber-700 hover:bg-amber-50 transition-colors disabled:opacity-50"
                      :disabled="undoingIds.includes(op.id)"
                      @click="confirmSingleUndo(op)"
                    >Rueckgaengig</button>
                  </template>
                  <template x-if="op.status !== 'completed'">
                    <span class="text-xs text-gray-300">--</span>
                  </template>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>
  </div>

  <!-- ================================================================== -->
  <!-- PAGINATION                                                          -->
  <!-- ================================================================== -->
  <div class="flex items-center justify-between mt-4" x-show="totalPages > 1">
    <button
      class="text-sm px-3 py-1.5 rounded-md border border-gray-300 text-gray-600 hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed"
      :disabled="page <= 1"
      @click="page--; loadOperations()"
    >Zurueck</button>
    <span class="text-sm text-gray-500">
      Seite <span x-text="page"></span> / <span x-text="totalPages"></span>
    </span>
    <button
      class="text-sm px-3 py-1.5 rounded-md border border-gray-300 text-gray-600 hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed"
      :disabled="page >= totalPages"
      @click="page++; loadOperations()"
    >Weiter</button>
  </div>

  <!-- ================================================================== -->
  <!-- CONFIRMATION MODAL                                                  -->
  <!-- ================================================================== -->
  <div
    x-show="showModal"
    x-cloak
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
    @click.self="showModal = false"
  >
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-2" x-text="modalTitle"></h3>
      <p class="text-sm text-gray-600 mb-4" x-text="modalMessage"></p>
      <div class="flex gap-3 justify-end">
        <button
          class="text-sm px-4 py-2 rounded-md border border-gray-300 text-gray-600 hover:bg-gray-50"
          @click="showModal = false"
        >Abbrechen</button>
        <button
          class="text-sm px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 font-medium"
          @click="executeUndo()"
        >Rueckgaengig machen</button>
      </div>
    </div>
  </div>

  <!-- ================================================================== -->
  <!-- TOAST / INLINE MESSAGE                                              -->
  <!-- ================================================================== -->
  <div
    x-show="toast.show"
    x-cloak
    x-transition:enter="transition ease-out duration-200"
    x-transition:leave="transition ease-in duration-150"
    class="fixed bottom-6 right-6 z-50 max-w-sm"
  >
    <div
      class="rounded-lg shadow-lg p-4 text-sm"
      :class="toast.success ? 'bg-green-50 border border-green-200 text-green-800' : 'bg-red-50 border border-red-200 text-red-800'"
    >
      <p x-text="toast.message"></p>
    </div>
  </div>

</div>

<script>
function historyApp() {
  return {
    // Data
    operations: [],
    batches: [],
    opsLoading: true,
    batchesLoading: true,
    filter: null,
    page: 1,
    pageSize: 50,
    totalCount: 0,
    totalPages: 1,

    // Undo state
    undoingIds: [],
    undoProgress: {},
    pollingIntervals: {},

    // Modal
    showModal: false,
    modalTitle: '',
    modalMessage: '',
    pendingUndo: null,

    // Toast
    toast: { show: false, success: true, message: '' },

    async init() {
      await Promise.all([this.loadOperations(), this.loadBatches()]);
    },

    async loadOperations() {
      this.opsLoading = true;
      try {
        let url = `/history/operations?page=${this.page}&page_size=${this.pageSize}`;
        if (this.filter) url += `&operation_type=${this.filter}`;
        const resp = await fetch(url);
        this.operations = await resp.json();

        // Get total count for pagination
        let countUrl = '/history/operations/count';
        if (this.filter) countUrl += `?operation_type=${this.filter}`;
        const countResp = await fetch(countUrl);
        const countData = await countResp.json();
        this.totalCount = countData.total;
        this.totalPages = Math.max(1, Math.ceil(this.totalCount / this.pageSize));
      } catch (e) {
        console.error('Failed to load operations:', e);
      }
      this.opsLoading = false;
    },

    async loadBatches() {
      this.batchesLoading = true;
      try {
        const resp = await fetch('/history/batches');
        this.batches = await resp.json();
      } catch (e) {
        console.error('Failed to load batches:', e);
      }
      this.batchesLoading = false;
    },

    confirmSingleUndo(op) {
      const fileName = this.extractFileName(op.target_path);
      this.modalTitle = 'Einzelne Operation rueckgaengig machen';
      this.modalMessage = `Datei "${fileName}" zurueck nach ${op.source_path} verschieben?`;
      this.pendingUndo = { type: 'single', id: op.id };
      this.showModal = true;
    },

    confirmBatchUndo(batch) {
      this.modalTitle = 'Ganzen Batch rueckgaengig machen';
      this.modalMessage = `Wirklich alle ${batch.file_count} Dateien dieses Batches rueckgaengig machen?`;
      this.pendingUndo = { type: 'batch', batchId: batch.batch_id };
      this.showModal = true;
    },

    async executeUndo() {
      this.showModal = false;
      if (!this.pendingUndo) return;

      if (this.pendingUndo.type === 'single') {
        await this.doSingleUndo(this.pendingUndo.id);
      } else {
        await this.doBatchUndo(this.pendingUndo.batchId);
      }
      this.pendingUndo = null;
    },

    async doSingleUndo(operationId) {
      this.undoingIds.push(operationId);
      try {
        const resp = await fetch(`/history/undo/${operationId}`, { method: 'POST' });
        const data = await resp.json();
        this.showToast(data.success, data.message);
        // Refresh data
        await Promise.all([this.loadOperations(), this.loadBatches()]);
      } catch (e) {
        this.showToast(false, 'Netzwerkfehler beim Undo.');
      }
      this.undoingIds = this.undoingIds.filter(id => id !== operationId);
    },

    async doBatchUndo(batchId) {
      try {
        const resp = await fetch(`/history/undo/batch/${batchId}`, { method: 'POST' });
        const data = await resp.json();
        if (!data.success && resp.status !== 202) {
          this.showToast(false, data.message);
          return;
        }
        // Start polling
        this.startPolling(batchId);
      } catch (e) {
        this.showToast(false, 'Netzwerkfehler beim Batch-Undo.');
      }
    },

    startPolling(batchId) {
      if (this.pollingIntervals[batchId]) return;
      this.pollingIntervals[batchId] = setInterval(async () => {
        try {
          const resp = await fetch(`/history/batch/${batchId}/status`);
          const data = await resp.json();
          this.undoProgress[batchId] = data;

          if (data.done) {
            clearInterval(this.pollingIntervals[batchId]);
            delete this.pollingIntervals[batchId];
            const msg = `${data.reverted} rueckgaengig gemacht` +
              (data.failed > 0 ? `, ${data.failed} fehlgeschlagen` : '');
            this.showToast(data.failed === 0, msg);
            // Refresh data
            await Promise.all([this.loadOperations(), this.loadBatches()]);
          }
        } catch (e) {
          console.error('Polling error:', e);
        }
      }, 1000);
    },

    showToast(success, message) {
      this.toast = { show: true, success, message };
      setTimeout(() => { this.toast.show = false; }, 4000);
    },

    formatTimestamp(ts) {
      if (!ts) return '--';
      try {
        const d = new Date(ts);
        return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })
          + ' ' + d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
      } catch (e) {
        return ts;
      }
    },

    extractFileName(path) {
      if (!path) return '';
      const parts = path.split('/');
      return parts[parts.length - 1];
    },

    shortenPath(path) {
      if (!path) return '';
      // Show last 3 segments
      const parts = path.split('/');
      if (parts.length <= 4) return path;
      return '.../' + parts.slice(-3).join('/');
    },
  };
}
</script>

{% endblock %}
